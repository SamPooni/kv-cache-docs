<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chapter 8: MoE Routing Support — KV-Cache Offloading</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="watermark">
    © 2025 Subramaniyam (Sam) Pooni<br>
    All Rights Reserved<br>
    Proprietary & Confidential
  </div>

  <nav class="nav">
    <div class="nav-inner">
      <a href="../index.html" class="nav-brand"><span class="nav-brand-icon">⚡</span> KV-Cache Architecture</a>
      <div class="nav-links">
        <a href="ch07-kv-cache.html" class="nav-link">KV-Cache</a>
        <a href="ch08-moe.html" class="nav-link active">MoE</a>
        <a href="ch09-gpu-integration.html" class="nav-link">GPU</a>
        <a href="ch10-market.html" class="nav-link">Market</a>
        <a href="../appendix/index.html" class="nav-link">Appendix</a>
      </div>
    </div>
  </nav>

  <div class="page-wrapper">
    <div class="container">
      <header class="chapter-header">
        <div class="chapter-label">Chapter 8</div>
        <h1 class="chapter-title">MoE Routing Support</h1>
        <p class="chapter-subtitle">Handling Mixture-of-Experts models with routing histograms, activation frequency tracking, and adaptive expert caching strategies.</p>
      </header>

      <h2>8.1 Mixture-of-Experts Architecture</h2>

      <p>MoE models (Mixtral, DeepSeek, DBRX) use sparse activation to scale parameter count without proportional compute increase:</p>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Parameter</th><th>Typical Value</th><th>Example (Mixtral-8×22B)</th></tr>
          </thead>
          <tbody>
            <tr><td>N (total experts)</td><td class="mono">8-64</td><td class="mono">8</td></tr>
            <tr><td>K (activated per token)</td><td class="mono">2-4</td><td class="mono">2</td></tr>
            <tr><td>Expert type</td><td>FFN blocks</td><td>22B each</td></tr>
            <tr><td>Total parameters</td><td>—</td><td class="mono">176B</td></tr>
            <tr><td>Active parameters</td><td>—</td><td class="mono highlight">44B</td></tr>
          </tbody>
        </table>
      </div>

      <h3>Learned Router Behavior</h3>

      <pre><code>def moe_router(hidden_state, W_router, K):
    """Select top-K experts for each token."""
    router_logits = hidden_state @ W_router  # [batch, seq, num_experts]
    top_k_logits, top_k_indices = torch.topk(router_logits, K, dim=-1)
    expert_weights = F.softmax(top_k_logits, dim=-1)
    return expert_weights, top_k_indices</code></pre>

      <p>Router weights are learned during training, creating <strong>data-dependent expert selection</strong> that varies per token.</p>

      <h2>8.2 The Challenge</h2>

      <h3>Data-Dependent Access Patterns</h3>

      <p>Unlike attention (where access patterns follow query-key similarity), MoE routing depends on:</p>

      <ul>
        <li><strong>Input token content</strong>: Different tokens → different experts</li>
        <li><strong>Hidden state evolution</strong>: Layer-dependent routing</li>
        <li><strong>Learned router biases</strong>: Training-determined preferences</li>
      </ul>

      <p>This creates <strong>unpredictable, per-token access patterns</strong> that defeat simple prefetch strategies.</p>

      <h3>Irregular, Sparse Activation</h3>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Metric</th><th>Value</th></tr>
          </thead>
          <tbody>
            <tr><td>Per-token activation</td><td class="mono">25% of expert parameters (2/8)</td></tr>
            <tr><td>Batch activation variance</td><td class="mono warning">High</td></tr>
            <tr><td>Worst case</td><td class="mono danger">All 8 experts needed</td></tr>
          </tbody>
        </table>
      </div>

      <h2>8.3 Endpoint Approach</h2>

      <h3>Routing Histogram</h3>

      <p>We maintain per-layer expert activation histograms using EMA:</p>

      <pre><code>class RoutingHistogram:
    def __init__(self, num_layers, num_experts, alpha=0.1):
        self.ema_rates = np.zeros((num_layers, num_experts))
    
    def update(self, layer, expert_ids, batch_size):
        current_rates = one_hot(expert_ids) / batch_size
        self.ema_rates[layer] = (
            alpha * current_rates + 
            (1 - alpha) * self.ema_rates[layer]
        )
    
    def get_hot_experts(self, layer, threshold=0.2):
        return [i for i, rate in enumerate(self.ema_rates[layer])
                if rate > threshold]</code></pre>

      <h3>Expert Classification Strategy</h3>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Activation Rate</th><th>Class</th><th>Cache Action</th></tr>
          </thead>
          <tbody>
            <tr><td class="mono">&gt; 30%</td><td style="color: var(--accent-red);"><strong>Hot</strong></td><td>Always in DRAM</td></tr>
            <tr><td class="mono">10-30%</td><td style="color: var(--accent-orange);"><strong>Warm</strong></td><td>Prefetch if capacity</td></tr>
            <tr><td class="mono">&lt; 10%</td><td style="color: var(--accent-cyan);"><strong>Cold</strong></td><td>On-demand fetch</td></tr>
          </tbody>
        </table>
      </div>

      <h2>8.4 Cache Sizing Strategy</h2>

      <div class="comparison-grid">
        <div class="card">
          <h4 style="margin-top: 0; color: var(--accent-green);">Full Replication</h4>
          <p style="font-size: 0.95rem;">If endpoint DRAM can hold all experts:</p>
          <ul style="font-size: 0.9rem; margin-bottom: 0;">
            <li>Zero prefetch latency</li>
            <li>100% hit rate</li>
            <li>Maximum memory usage</li>
          </ul>
        </div>
        <div class="card">
          <h4 style="margin-top: 0; color: var(--accent-orange);">Histogram Prefetch</h4>
          <p style="font-size: 0.95rem;">When memory-constrained:</p>
          <ul style="font-size: 0.9rem; margin-bottom: 0;">
            <li>40-60% memory savings</li>
            <li>85-95% hit rate</li>
            <li>Accept rare expert misses</li>
          </ul>
        </div>
      </div>

      <h3>Summary: MoE Cache Strategy Matrix</h3>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Memory Pressure</th><th>Strategy</th><th>Expected Hit Rate</th></tr>
          </thead>
          <tbody>
            <tr><td>Low (&lt;50%)</td><td>Full replication</td><td class="mono highlight">100%</td></tr>
            <tr><td>Medium (50-80%)</td><td>Top-K caching</td><td class="mono">85-95%</td></tr>
            <tr><td>High (&gt;80%)</td><td>Histogram + routing</td><td class="mono warning">70-85%</td></tr>
          </tbody>
        </table>
      </div>

      <div class="chapter-nav">
        <a href="ch07-kv-cache.html" class="chapter-nav-btn prev">
          <span class="chapter-nav-label">← Previous</span>
          <span class="chapter-nav-title">Chapter 7: KV-Cache</span>
        </a>
        <a href="ch09-gpu-integration.html" class="chapter-nav-btn next">
          <span class="chapter-nav-label">Next Chapter →</span>
          <span class="chapter-nav-title">Chapter 9: GPU Integration</span>
        </a>
      </div>
    </div>
    <footer class="footer">
      <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-primary);">
        <p style="font-size: 0.8rem; color: var(--text-muted);">
          © 2025 Subramaniyam (Sam) Pooni. All Rights Reserved.<br>
          This document contains proprietary and confidential information.<br>
          Unauthorized reproduction or distribution is strictly prohibited.
        </p>
      </div>
      <p>Distributed Endpoint Architecture for KV-Cache Offloading in LLM Inference</p>
      <p style="margin-top: 0.5rem;">Technical Documentation v3.0 — December 2025</p>
    </footer>
  </div>
</body>
</html>
