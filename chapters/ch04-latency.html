<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chapter 4: Effective Latency Analysis ‚Äî KV-Cache Offloading</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .figure-embed {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      margin: 2rem 0;
      overflow: hidden;
    }
    .figure-embed-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-primary);
    }
    .figure-embed-label {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      color: var(--accent-cyan);
    }
    .figure-embed-link {
      font-size: 0.85rem;
      color: var(--accent-purple);
      text-decoration: none;
    }
    .figure-embed-link:hover { text-decoration: underline; }
    .figure-embed iframe {
      width: 100%;
      height: 550px;
      border: none;
      background: #fff;
    }
    .figure-embed.tall iframe { height: 700px; }
  </style>
</head>
<body>
  <div class="watermark">¬© 2025 Subramaniyam (Sam) Pooni<br>All Rights Reserved<br>Proprietary & Confidential</div>

  <nav class="nav">
    <div class="nav-inner">
      <a href="../index.html" class="nav-brand"><span class="nav-brand-icon">‚ö°</span> KV-Cache Architecture</a>
      <div class="nav-links">
        <a href="ch00-executive-summary.html" class="nav-link"><span class="nav-chapter-num">0</span> Summary</a>
        <a href="ch03-architecture.html" class="nav-link"><span class="nav-chapter-num">3</span> Architecture</a>
        <a href="ch04-latency.html" class="nav-link active"><span class="nav-chapter-num">4</span> Latency</a>
        <a href="../figures/index.html" class="nav-link">üìä Figures</a>
        <a href="../appendix/index.html" class="nav-link">Appendix</a>
      </div>
    </div>
  </nav>

  <div class="page-wrapper">
    <div class="container">
      <header class="chapter-header">
        <div class="chapter-label">Chapter 4</div>
        <h1 class="chapter-title">Effective Latency Analysis</h1>
        <p class="chapter-subtitle">Two-tier cache model, CXL vs PCIe comparison, and the 65√ó latency improvement.</p>
      </header>

      <div class="stats-grid" style="margin-bottom: 3rem;">
        <div class="stat-box"><div class="stat-value">9</div><div class="stat-label">Figures in Chapter</div></div>
        <div class="stat-box"><div class="stat-value">250 ns</div><div class="stat-label">CXL.mem</div></div>
        <div class="stat-box"><div class="stat-value">16 Œºs</div><div class="stat-label">PCIe DMA</div></div>
        <div class="stat-box"><div class="stat-value">65√ó</div><div class="stat-label">Improvement</div></div>
      </div>

      <!-- Section 4.1: Two-Tier Model -->
      <h2>4.1 Two-Tier Cache Model</h2>
      
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Tier</th><th>Media</th><th>Latency</th><th>Capacity</th></tr>
          </thead>
          <tbody>
            <tr><td>Tier 1</td><td>Endpoint DDR5</td><td class="mono highlight">250 ns</td><td class="mono">1 TB</td></tr>
            <tr><td>Tier 2</td><td>Endpoint NVMe</td><td class="mono warning">25 Œºs</td><td class="mono">16 TB</td></tr>
            <tr><td>Fallback</td><td>Recompute</td><td class="mono danger">50 ms</td><td class="mono">‚àû</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Section 4.2: Effective Latency -->
      <h2>4.2 Effective Latency Formula</h2>
      
      <div class="equation">
        L<sub>eff</sub> = Œ± √ó L<sub>dram</sub> + Œ≤ √ó L<sub>flash</sub> + Œ≥ √ó L<sub>recompute</sub>
        <span class="equation-label">Weighted average across cache tiers</span>
      </div>

      <p>With 85% DRAM hit rate, 14% flash hit, 1% miss:</p>
      
      <div class="derivation">
        <div class="derivation-step">
          <div class="step-num">Calculate:</div>
          <div class="step-content">
            <div class="step-eq">L<sub>eff</sub> = 0.85 √ó 250 ns + 0.14 √ó 25 Œºs + 0.01 √ó 50 ms</div>
            <div class="step-eq">= 212.5 ns + 3.5 Œºs + 500 Œºs = <strong>504 Œºs ‚âà 0.5 ms</strong></div>
          </div>
        </div>
      </div>

      <div class="figure-embed tall">
        <div class="figure-embed-header">
          <span class="figure-embed-label">Figure 4.1 ‚Äî Effective Latency Analysis</span>
          <a href="../figures/ch04-latency/effective-latency-analysis.html" target="_blank" class="figure-embed-link">Open Full Screen ‚Üó</a>
        </div>
        <iframe src="../figures/ch04-latency/effective-latency-analysis.html"></iframe>
      </div>

      <!-- Section 4.3: CXL vs PCIe -->
      <h2>4.3 CXL.mem vs PCIe DMA Path Comparison</h2>
      
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Component</th><th>CXL.mem</th><th>PCIe DMA</th></tr>
          </thead>
          <tbody>
            <tr><td>CPU involvement</td><td class="mono highlight">None</td><td class="mono danger">Required (interrupt)</td></tr>
            <tr><td>Protocol overhead</td><td class="mono">100 ns</td><td class="mono">2-5 Œºs</td></tr>
            <tr><td>Memory access</td><td class="mono">100 ns</td><td class="mono">100 ns</td></tr>
            <tr><td>TLB management</td><td class="mono highlight">Hardware</td><td class="mono danger">Software (1-2 Œºs)</td></tr>
            <tr style="background: rgba(63,185,80,0.1);"><td><strong>Total</strong></td><td class="mono highlight"><strong>~250 ns</strong></td><td class="mono danger"><strong>5-16 Œºs</strong></td></tr>
          </tbody>
        </table>
      </div>

      <div class="figure-embed tall">
        <div class="figure-embed-header">
          <span class="figure-embed-label">Figure 4.2 ‚Äî Latency Path Comparison</span>
          <a href="../figures/ch04-latency/diagram-latency-path-html.html" target="_blank" class="figure-embed-link">Open Full Screen ‚Üó</a>
        </div>
        <iframe src="../figures/ch04-latency/diagram-latency-path-html.html"></iframe>
      </div>

      <!-- Section 4.4: Waterfall -->
      <h2>4.4 Access Timeline (Waterfall)</h2>

      <div class="figure-embed">
        <div class="figure-embed-header">
          <span class="figure-embed-label">Figure 4.3 ‚Äî Latency Waterfall Diagram</span>
          <a href="../figures/ch04-latency/figure-2-5-latency-waterfall.html" target="_blank" class="figure-embed-link">View TSX Source ‚Üó</a>
        </div>
        <iframe src="../figures/ch04-latency/figure-2-5-latency-waterfall.html" style="background: #1a1a2e;"></iframe>
      </div>

      <div class="callout insight">
        <div class="callout-title">üöÄ 65√ó Latency Improvement</div>
        <p style="margin-bottom: 0;">CXL.mem eliminates CPU interrupt handling, explicit DMA setup, and software TLB management. Result: <strong>250 ns vs 16+ Œºs = 65√ó faster</strong></p>
      </div>

      <!-- Chapter Navigation -->
      <div class="chapter-nav">
        <a href="ch03-architecture.html" class="chapter-nav-btn prev">
          <span class="chapter-nav-label">‚Üê Previous</span>
          <span class="chapter-nav-title">Chapter 3: Architecture</span>
        </a>
        <a href="ch05-bandwidth.html" class="chapter-nav-btn next">
          <span class="chapter-nav-label">Next ‚Üí</span>
          <span class="chapter-nav-title">Chapter 5: Bandwidth</span>
        </a>
      </div>
    </div>

    <footer class="footer">
      <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-primary);">
        <p style="font-size: 0.8rem; color: var(--text-muted);">
          ¬© 2025 Subramaniyam (Sam) Pooni. All Rights Reserved.<br>
          This document contains proprietary and confidential information.
        </p>
      </div>
      <p>KV-Cache Offloading Architecture ‚Äî v3.0</p>
    </footer>
  </div>
</body>
</html>
